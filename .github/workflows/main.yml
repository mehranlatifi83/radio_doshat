name: Send APK to Telegram

on: 
  push:
    branches:
      - main
    paths:
      - 'app/release/*.apk'

jobs:
  send-apk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Get commit messages
        run: |
          commit_count=$(git rev-list --count HEAD ^$(git merge-base HEAD main))
          echo "COMMIT_COUNT=$commit_count" >> $GITHUB_ENV
          commits=$(git log --format='%h: %s by %an' -n $commit_count)
          echo "COMMIT_MESSAGES=$(echo "$commits")" >> $GITHUB_ENV
      
      - name: Find APK file
        run: |
          apk_path=$(find ./app/release -name '*.apk' | head -n 1)
          echo "APK_PATH=$apk_path" >> $GITHUB_ENV
      
      - name: Send APK to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          caption="ðŸ”¨ $COMMIT_COUNT new commits to radio_doshat:main:\n\n$COMMIT_MESSAGES"
          curl -F document="@${APK_PATH}" -F chat_id=$CHAT_ID -F caption="$caption" https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendDocument
